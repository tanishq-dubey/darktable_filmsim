name: Build darktable with Film Simulation

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake gcc g++ pkg-config \
            libgtk-3-dev libglib2.0-dev libjson-glib-dev libfftw3-dev \
            libxml2-dev libsqlite3-dev libcurl4-openssl-dev \
            libpng-dev libjpeg-dev libtiff-dev libexiv2-dev \
            liblensfun-dev libpugixml-dev libgphoto2-dev \
            liblcms2-dev libcolord-dev libcolord-gtk-dev \
            libgraphicsmagick1-dev libopenexr-dev \
            intltool xsltproc libsecret-1-dev \
            libheif-dev libjxl-dev libavif-dev \
            liblua5.4-dev libsdl2-dev libportmidi-dev \
            librsvg2-dev libwebp-dev \
            fuse libfuse2 appstream

      - name: Build darktable with filmsim
        run: |
          chmod +x ./scripts/build_darktable_with_filmsim.sh
          ./scripts/build_darktable_with_filmsim.sh -j$(nproc)

      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-gtk/releases/download/continuous/linuxdeploy-plugin-gtk-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr
          cp -r build/darktable_custom/* AppDir/usr/
          
          # Copy film profiles into AppDir
          mkdir -p AppDir/usr/share/darktable/filmsim
          cp data/film_profiles/*.json AppDir/usr/share/darktable/filmsim/
          cp data/jakob-and-hanika-2019-srgb.coeff AppDir/usr/share/darktable/filmsim/
          
          # Create desktop file
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/darktable-filmsim.desktop << 'EOF'
          [Desktop Entry]
          Name=darktable (Film Simulation)
          GenericName=Photo Editor
          Comment=Virtual lighttable and darkroom for photographers with film simulation
          Exec=darktable %U
          Icon=darktable
          Terminal=false
          Type=Application
          Categories=Graphics;Photography;
          MimeType=image/jpeg;image/png;image/tiff;
          EOF
          
          # Copy icon
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          cp build/darktable/data/pixmaps/darktable.svg AppDir/usr/share/icons/hicolor/scalable/apps/ || true
          
          # Create AppImage
          export DEPLOY_GTK_VERSION=3
          ./linuxdeploy-x86_64.AppImage --appdir AppDir \
            --plugin gtk \
            --desktop-file AppDir/usr/share/applications/darktable-filmsim.desktop \
            --output appimage || true
          
          # Rename output
          mv darktable*.AppImage darktable-filmsim-linux-x86_64.AppImage 2>/dev/null || \
          mv Darktable*.AppImage darktable-filmsim-linux-x86_64.AppImage 2>/dev/null || true

      - name: Create tarball fallback
        run: |
          cd build
          # Include film profiles in the tarball
          mkdir -p darktable_custom/share/darktable/filmsim
          cp ../data/film_profiles/*.json darktable_custom/share/darktable/filmsim/
          cp ../data/jakob-and-hanika-2019-srgb.coeff darktable_custom/share/darktable/filmsim/
          tar -czvf darktable-filmsim-linux-x86_64.tar.gz darktable_custom/

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-linux-x86_64-appimage
          path: darktable-filmsim-linux-x86_64.AppImage
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-linux-x86_64-tarball
          path: build/darktable-filmsim-linux-x86_64.tar.gz
          retention-days: 7

      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: |
            darktable-filmsim-linux-x86_64.AppImage
            build/darktable-filmsim-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          brew install cmake pkg-config gtk+3 json-glib fftw \
            libxml2 sqlite curl libpng jpeg-turbo libtiff exiv2 \
            lensfun pugixml libgphoto2 little-cms2 \
            graphicsmagick openexr intltool libxslt libomp \
            libheif jpeg-xl libavif lua sdl2 portmidi \
            adwaita-icon-theme iso-codes librsvg webp \
            gnu-sed dylibbundler create-dmg || true

      - name: Build darktable with filmsim
        run: |
          export OpenMP_ROOT=$(brew --prefix)/opt/libomp
          chmod +x ./scripts/build_darktable_with_filmsim.sh
          ./scripts/build_darktable_with_filmsim.sh -j$(sysctl -n hw.ncpu)

      - name: Create macOS App Bundle
        run: |
          APP_NAME="darktable-filmsim"
          APP_DIR="build/${APP_NAME}.app"
          
          # Create app bundle structure
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          mkdir -p "${APP_DIR}/Contents/Resources/share/darktable"
          mkdir -p "${APP_DIR}/Contents/Frameworks"
          
          # Copy main binary and libraries
          cp -r build/darktable_custom/bin/* "${APP_DIR}/Contents/MacOS/"
          cp -r build/darktable_custom/lib/* "${APP_DIR}/Contents/Frameworks/" 2>/dev/null || true
          cp -r build/darktable_custom/share/darktable/* "${APP_DIR}/Contents/Resources/share/darktable/"
          
          # Copy film profiles
          mkdir -p "${APP_DIR}/Contents/Resources/share/darktable/filmsim"
          cp data/film_profiles/*.json "${APP_DIR}/Contents/Resources/share/darktable/filmsim/"
          cp data/jakob-and-hanika-2019-srgb.coeff "${APP_DIR}/Contents/Resources/share/darktable/filmsim/"
          
          # Create Info.plist
          cat > "${APP_DIR}/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>darktable</string>
              <key>CFBundleIdentifier</key>
              <string>org.darktable.filmsim</string>
              <key>CFBundleName</key>
              <string>darktable Film Simulation</string>
              <key>CFBundleDisplayName</key>
              <string>darktable (Film Simulation)</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleSignature</key>
              <string>????</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
          </dict>
          </plist>
          EOF
          
          # Bundle dependencies using dylibbundler
          cd "${APP_DIR}/Contents"
          dylibbundler -od -b -x MacOS/darktable -d Frameworks/ -p @executable_path/../Frameworks/ 2>/dev/null || echo "dylibbundler completed with warnings"
          cd -
          
          # Create DMG
          create-dmg \
            --volname "darktable Film Simulation" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 425 175 \
            --icon "${APP_NAME}.app" 175 175 \
            "build/darktable-filmsim-macos-arm64.dmg" \
            "${APP_DIR}" || true
          
          # Fallback: create zip if DMG fails
          if [ ! -f "build/darktable-filmsim-macos-arm64.dmg" ]; then
            cd build
            zip -r darktable-filmsim-macos-arm64.zip "${APP_NAME}.app"
            cd -
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-macos-arm64
          path: |
            build/darktable-filmsim-macos-arm64.dmg
            build/darktable-filmsim-macos-arm64.zip
            build/darktable-filmsim.app
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload release artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            build/darktable-filmsim-macos-arm64.dmg
            build/darktable-filmsim-macos-arm64.zip

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: linux-release

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: macos-release

      - name: List artifacts
        run: |
          echo "Linux artifacts:"
          ls -la linux-release/ || true
          echo "macOS artifacts:"
          ls -la macos-release/ || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-release/*
            macos-release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Installation
            
            ### macOS
            1. Download `darktable-filmsim-macos-arm64.dmg`
            2. Open the DMG and drag darktable to Applications
            3. Film profiles are bundled inside the app
            
            ### Linux
            **AppImage (recommended):**
            1. Download `darktable-filmsim-linux-x86_64.AppImage`
            2. Make executable: `chmod +x darktable-filmsim-linux-x86_64.AppImage`
            3. Run: `./darktable-filmsim-linux-x86_64.AppImage`
            
            **Tarball:**
            1. Download and extract `darktable-filmsim-linux-x86_64.tar.gz`
            2. Copy film profiles: `cp -r darktable_custom/share/darktable/filmsim ~/.config/darktable/`
            3. Run: `./darktable_custom/bin/darktable`
            
            ## Film Profiles
            The film simulation module includes 18 film profiles. They are bundled in the release packages.
