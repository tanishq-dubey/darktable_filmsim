name: Build darktable with Film Simulation

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake gcc g++ pkg-config \
            libgtk-3-dev libglib2.0-dev libjson-glib-dev libfftw3-dev \
            libxml2-dev libsqlite3-dev libcurl4-openssl-dev \
            libpng-dev libjpeg-dev libtiff-dev libexiv2-dev \
            liblensfun-dev libpugixml-dev libgphoto2-dev \
            liblcms2-dev libcolord-dev libcolord-gtk-dev \
            libgraphicsmagick1-dev libopenexr-dev \
            intltool xsltproc libsecret-1-dev \
            libheif-dev libavif-dev \
            liblua5.4-dev libsdl2-dev libportmidi-dev \
            librsvg2-dev libwebp-dev \
            fuse libfuse2 appstream
          # libjxl-dev is optional - install if available
          sudo apt-get install -y libjxl-dev || true

      - name: Build darktable with filmsim
        run: |
          chmod +x ./scripts/build_darktable_with_filmsim.sh
          ./scripts/build_darktable_with_filmsim.sh -j$(nproc)

      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-gtk/releases/download/continuous/linuxdeploy-plugin-gtk-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr
          cp -r build/darktable_custom/* AppDir/usr/
          
          # Copy film profiles into AppDir
          mkdir -p AppDir/usr/share/darktable/filmsim
          cp data/film_profiles/*.json AppDir/usr/share/darktable/filmsim/
          cp data/jakob-and-hanika-2019-srgb.coeff AppDir/usr/share/darktable/filmsim/
          
          # Create desktop file
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/darktable-filmsim.desktop << 'EOF'
          [Desktop Entry]
          Name=darktable (Film Simulation)
          GenericName=Photo Editor
          Comment=Virtual lighttable and darkroom for photographers with film simulation
          Exec=darktable %U
          Icon=darktable
          Terminal=false
          Type=Application
          Categories=Graphics;Photography;
          MimeType=image/jpeg;image/png;image/tiff;
          EOF
          
          # Copy icon
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          cp build/darktable/data/pixmaps/darktable.svg AppDir/usr/share/icons/hicolor/scalable/apps/ || true
          
          # Create AppImage
          export DEPLOY_GTK_VERSION=3
          ./linuxdeploy-x86_64.AppImage --appdir AppDir \
            --plugin gtk \
            --desktop-file AppDir/usr/share/applications/darktable-filmsim.desktop \
            --output appimage || true
          
          # Rename output
          mv darktable*.AppImage darktable-filmsim-linux-x86_64.AppImage 2>/dev/null || \
          mv Darktable*.AppImage darktable-filmsim-linux-x86_64.AppImage 2>/dev/null || true

      - name: Create tarball fallback
        run: |
          cd build
          # Include film profiles in the tarball
          mkdir -p darktable_custom/share/darktable/filmsim
          cp ../data/film_profiles/*.json darktable_custom/share/darktable/filmsim/
          cp ../data/jakob-and-hanika-2019-srgb.coeff darktable_custom/share/darktable/filmsim/
          tar -czvf darktable-filmsim-linux-x86_64.tar.gz darktable_custom/

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-linux-x86_64-appimage
          path: darktable-filmsim-linux-x86_64.AppImage
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-linux-x86_64-tarball
          path: build/darktable-filmsim-linux-x86_64.tar.gz
          retention-days: 7

      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: |
            darktable-filmsim-linux-x86_64.AppImage
            build/darktable-filmsim-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          brew install cmake pkg-config gtk+3 json-glib fftw \
            libxml2 sqlite curl libpng jpeg-turbo libtiff exiv2 \
            lensfun pugixml libgphoto2 little-cms2 \
            graphicsmagick openexr intltool libxslt libomp \
            libheif jpeg-xl libavif lua sdl2 portmidi \
            adwaita-icon-theme iso-codes librsvg webp \
            gnu-sed || true

      - name: Build darktable with filmsim
        run: |
          export OpenMP_ROOT=$(brew --prefix)/opt/libomp
          chmod +x ./scripts/build_darktable_with_filmsim.sh
          ./scripts/build_darktable_with_filmsim.sh -j$(sysctl -n hw.ncpu)

      - name: Create macOS release package
        run: |
          cd build
          
          # Include film profiles in the release
          mkdir -p darktable_custom/share/darktable/filmsim
          cp ../data/film_profiles/*.json darktable_custom/share/darktable/filmsim/
          cp ../data/jakob-and-hanika-2019-srgb.coeff darktable_custom/share/darktable/filmsim/
          
          # Create a tarball (simpler and more reliable than DMG for CI)
          tar -czvf darktable-filmsim-macos-arm64.tar.gz darktable_custom/
          
          cd -

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: darktable-filmsim-macos-arm64
          path: build/darktable-filmsim-macos-arm64.tar.gz
          retention-days: 7

      - name: Upload release artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: build/darktable-filmsim-macos-arm64.tar.gz

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: linux-release

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: macos-release

      - name: List artifacts
        run: |
          echo "Linux artifacts:"
          ls -la linux-release/ || true
          echo "macOS artifacts:"
          ls -la macos-release/ || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-release/*
            macos-release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Installation
            
            ### Linux
            **AppImage (recommended - self-contained):**
            1. Download `darktable-filmsim-linux-x86_64.AppImage`
            2. Make executable: `chmod +x darktable-filmsim-linux-x86_64.AppImage`
            3. Run: `./darktable-filmsim-linux-x86_64.AppImage`
            
            **Tarball:**
            1. Download and extract `darktable-filmsim-linux-x86_64.tar.gz`
            2. Copy film profiles: `mkdir -p ~/.config/darktable && cp -r darktable_custom/share/darktable/filmsim ~/.config/darktable/`
            3. Run: `./darktable_custom/bin/darktable`
            
            ### macOS
            1. Install dependencies: `brew install gtk+3 json-glib fftw libxml2 sqlite exiv2 lensfun pugixml libgphoto2 little-cms2 graphicsmagick openexr libomp libheif jpeg-xl libavif lua sdl2 librsvg webp adwaita-icon-theme`
            2. Download and extract `darktable-filmsim-macos-arm64.tar.gz`
            3. Copy film profiles: `mkdir -p ~/.config/darktable && cp -r darktable_custom/share/darktable/filmsim ~/.config/darktable/`
            4. Run: `./darktable_custom/bin/darktable`
            
            ## Film Profiles
            The film simulation module includes 18 film profiles. They are bundled in the release packages.
